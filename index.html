<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Horse Racer</title>
    <!-- Latest compiled and minified CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Latest compiled JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3"></script>

    <style>
        .logo {
            width: 4em;
        }
    </style>
</head>

<body>

    <div id="app" class="container-fluid d-flex flex-column">
        
        <header class="p-3 d-flex align-items-center">
            <div><img src="horse.png" class="logo"></div>
            <span class="display-5">Horse Racer</span>
        </header>

        <div class="container-fluid d-flex justify-content-between align-items-center border border-dark rounded py-2">
            <span>Cash: ${{ cash }}</span>
            <span>Race: {{ raceCount }}</span>            
        </div>

        <div class="flex-grow-1 container-fluid py-2">
            <div v-for="horseNumber in race.racingHorses" class="d-flex">
                <div style="width: 3em;">
                    {{ getHorseOdds(horseNumber) }}:1
                </div>
                <div style="width: 11em">
                    <span>{{ horses[horseNumber].name }}</span>
                    <span v-if="horses[horseNumber].placing" :class="{ 'fw-bold': horses[horseNumber].placing < 4 }"> ({{ horses[horseNumber].placing }})</span>
                </div>
                <input class="flex-grow-1" type="range" min="0" :max="settings.trackLength" v-model="horses[horseNumber].position" disabled>
            </div>
        </div>

        <button type="button" class="btn btn-outline-dark" @click="initRace" v-if="race.status == 2">Next race</button>
        <button type="button" class="btn btn-outline-dark" @click="startRace" v-if="race.status == 0">Start race</button>

    </div>

    <script>

        const vueApp = {

            data() {
                return {
                    cash: 150,
                    raceCount: 0,
                    horses: [{"name":"Tiny tot"},{"name":"Acne face"},{"name":"Ahtylopy"},{"name":"Big red"},{"name":"Big sister"},{"name":"Big bang"},{"name":"Bad smell"},{"name":"Cindy"},{"name":"Constallation"},{"name":"Jockys hope"},{"name":"Pushme then"},{"name":"Endless track"},{"name":"Filly folly"},{"name":"Flying nun"},{"name":"Piccolo player"},{"name":"Felicity"},{"name":"Heidi's horror"},{"name":"Down under"},{"name":"Dull thunder"},{"name":"David's delight"},{"name":"Hozaya"},{"name":"Hot feet"},{"name":"Isabel"},{"name":"Izaya"},{"name":"Joshua"},{"name":"Machorse"},{"name":"Jack"},{"name":"Jill"},{"name":"Kakapo"},{"name":"Knight rider"},{"name":"King wonder"},{"name":"Lady Di"},{"name":"Lightning bolt"},{"name":"Macwonder"},{"name":"Lost scalp"},{"name":"Nehemiah"},{"name":"Quick hoof"},{"name":"Oats"},{"name":"Polly"},{"name":"Phooy"},{"name":"Paperback"},{"name":"Quantum leap"},{"name":"Quark"},{"name":"Super slow"},{"name":"Slangdally"},{"name":"Tinkerbell"},{"name":"Unsaturated"},{"name":"Umber hulk"},{"name":"Velvet"},{"name":"Yellow belly"},{"name":"Nobodies loss"}],
                    horsesPool: [],
                    race: {},

                    settings: {
                        maxHorsesPool: 20,
                        horsesPerRace: 8,
                        trackLength: 1600,
                        raceIntervalMs: 50,
                        moveConstant: 1,
                        speedInfluence: 0.035,
                        luckInfluence: 0.025,
                        randomInfluence: 5
                    }
                }
            },

            methods: {
                    
                getRandomArrayPositions(arr, size) {
                    const positionMax = arr.length - 1

                    let positions = []
                    for (let i = 0; i < size; i++) {
                        let newPosition = Math.round(Math.random() * positionMax)

                        while (positions.includes(newPosition)) {
                            newPosition = Math.round(Math.random() * positionMax)
                        }

                        positions.push(newPosition)
                    }

                    return positions
                },

                initHorsesPool() {
                    this.horsesPool = this.getRandomArrayPositions(this.horses, this.settings.maxHorsesPool)

                    for (horseNumber of this.horsesPool) {
                        this.horses[horseNumber].speed = Math.floor(Math.random() * 9) + 1 // 1 to 10
                        // horse.stamina = Math.floor(Math.random() * 9) + 1 // 1 to 10
                        this.horses[horseNumber].luck = Math.floor(Math.random() * 9) + 1 // 1 to 10
                        this.horses[horseNumber].wins = 0
                        this.horses[horseNumber].losses = 0
                        this.horses[horseNumber].position = 0
                    }
                },

                initRace() {
                    this.raceCount++

                    this.race = {}

                    this.race.status = 0
                    this.race.finishedCount = 0
                    this.race.racingHorses = []

                    for (horse of this.horses) {
                        horse.position = 0
                        horse.placing = 0
                        horse.finished = false
                    }

                    const randomArray = this.getRandomArrayPositions(this.horsesPool, this.settings.horsesPerRace)
                    for (position of randomArray) {
                        this.race.racingHorses.push(this.horsesPool[position])
                    }

                    this.race.oddsTotal = 0

                    for (position of this.race.racingHorses) {
                        this.race.oddsTotal += this.horses[position].speed * 2 + this.horses[position].luck
                    }
                    
                },

                startRace() {
                    // while (this.race.finishedCount < this.settings.horsesPerRace) {
                        // console.log(this.race.finishedCount + "|" + this.settings.maxHorsesPool)
                        
                    // }
                    this.race.status = 1

                    let raceInterval = setInterval(() => {
                        this.moveHorses()

                        if (this.race.finishedCount == this.settings.horsesPerRace) {
                            this.race.status = 2
                            clearInterval(raceInterval)
                        }
                    }, this.settings.raceIntervalMs)
                },

                moveHorses() {
                        for (horseNumber of this.race.racingHorses) {
                            this.moveHorse(horseNumber)
                        }
                },

                moveHorse(horseNumber) {
                    if (!this.horses[horseNumber].finished) {
                        const randomFactor = this.settings.randomInfluence * Math.round(Math.random())
                        const horseSpeedFactor = this.settings.speedInfluence * this.horses[horseNumber].speed
                        const horseLuckFactor = this.settings.luckInfluence * this.horses[horseNumber].luck
                        this.horses[horseNumber].position += this.settings.moveConstant + randomFactor + horseSpeedFactor + horseLuckFactor
                        if (this.horses[horseNumber].position >= this.settings.trackLength) {
                            this.horses[horseNumber].finished = true
                            this.race.finishedCount += 1
                            this.horses[horseNumber].placing = this.race.finishedCount
                        }
                    }

                },

                getHorseOdds(horseNumber) {
                    return Math.floor((this.race.oddsTotal - (this.horses[horseNumber].speed * 2 + this.horses[horseNumber].luck)) / (this.horses[horseNumber].speed * 2 + this.horses[horseNumber].luck) ) - 1
                }

            },

            mounted() {
                this.initHorsesPool()
                this.initRace()
            }
            
        }

        app = Vue.createApp(vueApp)
        vm = app.mount("#app")
    </script>
</body>

</html>